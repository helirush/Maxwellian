# Thermal Burden Calculation Fix - December 2024

## Issue Summary
Loaders 2 and 6 were displaying incorrect thermal burden values compared to Loaders 1, 3, 4, and 5.

**Expected Value:** ~808,880 BTU/hr  
**Wrong Values:** Loader 2 = 874,983 BTU/hr, Loader 6 = varying incorrect values

## Root Cause Analysis

### Problem 1: Incorrect BTU Calculation in ePerformance.py
**File:** `/Users/mdhowell/eestream/eBehavior/core/ePerformance.py`

**Lines 3518-3519** were using `device_zone_btu` instead of `btu_after_vthd`:

```python
# WRONG:
'heat_forensics_value': int(device_zone_btu * 24 * 365 * electricity_rate / 3412.142),
'heat_value_year': int(device_zone_btu * 24 * 365 * electricity_rate / 3412.142),
```

**Line 3533** was correctly set:
```python
# CORRECT:
'heat_forensics_btu': int(btu_after_vthd),
```

### Problem 2: Data Flow Architecture Issue
The loaders were reading values from JSON files generated by eBehavior, not recalculating them:

```
eBehavior Analysis → Generates JSON files → Loaders read from JSON
```

**File:** `/Users/mdhowell/eestream/eBehavior/dashboard/dashboard_integration.py`  
**Lines 144-145:**
```python
enhanced_summary['heat_forensics_btu'] = transformer_data.get('heat_forensics_btu', 128480)
enhanced_summary['heat_forensics_value'] = transformer_data.get('heat_forensics_value', 92461)
```

If JSON files had wrong values (or were missing them), loaders would use incorrect defaults.

### Problem 3: Energyboard Waste Value Display
**File:** `/Users/mdhowell/eestream/eBehavior/dashboard/templates/eUnityEnergyboard.html`

**Line 1256** had hardcoded text:
```html
<div class="waste-value">VALUE: $92,461 per year</div>
```

JavaScript was not updating this value dynamically, causing it to show the same yearly value twice instead of showing an hourly rate.

## The Fix

### Fix 1: Correct Thermal Burden Calculation (ePerformance.py)
**Commit:** `fd7f77d` (partial), earlier commit

Changed lines 3518-3519 to use `btu_after_vthd`:
```python
# FIXED:
'heat_forensics_value': int(btu_after_vthd * 24 * 365 * electricity_rate / 3412.142),
'heat_value_year': int(btu_after_vthd * 24 * 365 * electricity_rate / 3412.142),
```

**Why `btu_after_vthd` is correct:**

From the heat calculation pipeline:
1. `baseline_btu` = (supply_kva - consumption_kw) × 3412.142
2. `btu_vhi` = baseline_btu × (1.0 + vhi_factor) - after voltage sag
3. `btu_hhi` = btu_vhi × (1.0 + hhi_factor) - after harmonic distortion
4. `btu_vthd` = btu_hhi × (1.0 + vthd_factor) - after voltage THD **← THERMAL BURDEN**
5. `btu_eci` = btu_vthd × ac_fraction - after AC exposure
6. `btu_final` (conditioned_btus) = btu_eci × (1.0 + gci_factor) - after climate

**Thermal Burden** = Heat generated BEFORE facility-specific AC exposure and climate factors apply.

### Fix 2: Dynamic Waste Value Display (eUnityEnergyboard.html)
**Commit:** `fd7f77d`

Added JavaScript after line 1410:
```javascript
// Update waste value cost (hourly rate)
const wasteCostElement = document.querySelector('.waste-value');
if (wasteCostElement && transformer.electrical_waste_kw && transformer.electricity_rate) {
  const costPerHour = transformer.electrical_waste_kw * transformer.electricity_rate;
  wasteCostElement.textContent = `VALUE: $${costPerHour.toFixed(2)} per hour`;
}
```

Now calculates: `electrical_waste_kw * electricity_rate` to show proper hourly cost.

## Implementation Requirements

### Critical: Re-run eBehavior Analysis
The fixes to `ePerformance.py` only take effect when the analysis is re-run to regenerate JSON files.

**Do NOT just "reset" the data** - you must:
1. Delete old JSON files (or the entire Study folder)
2. Re-run the full eBehavior analysis from scratch
3. New JSON files will contain corrected `heat_forensics_btu` and `heat_forensics_value`
4. Loaders will then read the correct values

## Architecture Principles Reinforced

### Single Source of Truth
- eBehavior performs ALL calculations ONCE
- Results are saved to canonical JSON files
- All downstream systems (loaders, dashboards, reports) READ from JSON
- NO recalculation in visualization layer

### Duplicate Calculation Paths = Bad
- If multiple code paths calculate the same value differently, inconsistencies appear
- Loader 2 and 6 issues were caused by this exact problem
- Solution: One calculation path in eBehavior, everyone else reads from it

## Testing Verification

After re-running the analysis, verify:
1. **Loader 1:** ~808,880 BTU/hr (baseline - should remain correct)
2. **Loader 2:** ~808,880 BTU/hr (was 874,983 - should now match)
3. **Loader 3:** ~808,880 BTU/hr (baseline - should remain correct)
4. **Loader 4:** ~808,880 BTU/hr (baseline - should remain correct)
5. **Loader 5:** ~808,880 BTU/hr (baseline - should remain correct)
6. **Loader 6:** ~808,880 BTU/hr (was different - should now match)

**Energyboard Waste Value:**
- Should show different values for hourly vs yearly
- Example: "$X.XX per hour" instead of "$372,065" showing twice

## Related Files Modified

1. `/Users/mdhowell/eestream/eBehavior/core/ePerformance.py` - Lines 3518-3519
2. `/Users/mdhowell/eestream/eBehavior/dashboard/templates/eUnityEnergyboard.html` - Added lines 1413-1418

## Git Commits
- Thermal burden fix: Earlier commit (check git log for exact hash)
- Waste value fix: `fd7f77d` - "Fix Energyboard waste value to display hourly cost dynamically"

## Session Notes
- User: Mr. Howell
- Date: December 17, 2024
- Key Learning: Always regenerate data files after fixing calculation code
- Reminder: Maintain single source of truth - calculate once, read everywhere

---
**Status:** FIXED - Awaiting analysis re-run for validation
